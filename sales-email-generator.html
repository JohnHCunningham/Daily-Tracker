<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Email & LinkedIn Generator | AI Advantage Solutions</title>

    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        /* Brand Colors */
        :root {
            --brand-navy: #0C1030;
            --brand-teal: #10C3B0;
            --brand-aqua: #3DE0D2;
            --brand-pink: #E64563;
            --brand-gold: #F4B03A;
            --brand-yellow: #F9C863;
            --light-text: #F2F4F8;
            --card-bg: #131a40;
            --input-bg: #090c26;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, var(--brand-navy) 0%, #050816 100%);
            color: var(--light-text);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            background: linear-gradient(135deg, var(--brand-aqua), var(--brand-teal));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }

        .header p {
            color: var(--brand-gold);
            font-size: 1.1rem;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1.5fr;
            gap: 25px;
            margin-bottom: 30px;
        }

        @media (max-width: 1024px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background-color: var(--card-bg);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            border: 1px solid rgba(61, 224, 210, 0.1);
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, var(--brand-teal), var(--brand-aqua));
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .card-title {
            color: var(--brand-aqua);
            font-size: 1.2rem;
            font-weight: 600;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--light-text);
            font-size: 0.9rem;
            font-weight: 500;
        }

        .input-group input,
        .input-group select,
        .input-group textarea {
            width: 100%;
            background-color: var(--input-bg);
            border: 1px solid rgba(255,255,255,0.1);
            color: var(--brand-teal);
            padding: 12px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 1rem;
        }

        .input-group input:focus,
        .input-group select:focus,
        .input-group textarea:focus {
            outline: none;
            border-color: var(--brand-aqua);
            box-shadow: 0 0 0 3px rgba(61, 224, 210, 0.1);
        }

        .input-group textarea {
            min-height: 80px;
            resize: vertical;
            font-family: inherit;
        }

        .btn {
            background: linear-gradient(135deg, var(--brand-gold), var(--brand-yellow));
            border: none;
            padding: 12px 24px;
            color: var(--brand-navy);
            font-weight: 700;
            border-radius: 50px;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            width: 100%;
            margin-top: 15px;
            font-size: 1rem;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(244, 176, 58, 0.4);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: linear-gradient(135deg, var(--brand-teal), var(--brand-aqua));
        }

        .email-output {
            background: var(--input-bg);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid rgba(61, 224, 210, 0.2);
            margin-bottom: 15px;
        }

        .email-subject {
            color: var(--brand-gold);
            font-weight: 700;
            font-size: 1.1rem;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .email-body {
            color: var(--light-text);
            line-height: 1.8;
            white-space: pre-wrap;
            font-size: 0.95rem;
        }

        .copy-btn {
            padding: 8px 16px;
            font-size: 0.9rem;
            width: auto;
            margin-top: 10px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-box {
            background: rgba(255,255,255,0.05);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--brand-gold);
        }

        .stat-label {
            font-size: 0.8rem;
            color: var(--light-text);
            opacity: 0.7;
            margin-top: 5px;
        }

        .alert {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            font-size: 0.9rem;
        }

        .alert-success {
            background: rgba(16, 195, 176, 0.2);
            border: 1px solid var(--brand-teal);
            color: var(--brand-aqua);
        }

        .alert-error {
            background: rgba(230, 69, 99, 0.2);
            border: 1px solid var(--brand-pink);
            color: var(--brand-pink);
        }

        .variations-container {
            display: grid;
            gap: 15px;
        }

        .variation {
            background: rgba(16, 195, 176, 0.1);
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid var(--brand-teal);
        }

        .variation-label {
            color: var(--brand-teal);
            font-weight: 700;
            font-size: 0.9rem;
            margin-bottom: 8px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--brand-teal);
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab {
            padding: 10px 20px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            color: var(--light-text);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .tab.active {
            background: linear-gradient(135deg, var(--brand-teal), var(--brand-aqua));
            color: var(--brand-navy);
            border-color: transparent;
        }

        .tab:hover:not(.active) {
            background: rgba(255,255,255,0.1);
        }

        .back-btn {
            display: inline-block;
            background: linear-gradient(135deg, var(--brand-teal), var(--brand-aqua));
            color: var(--brand-navy);
            padding: 10px 20px;
            border-radius: 25px;
            text-decoration: none;
            font-weight: 700;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            position: relative;
            z-index: 10;
            pointer-events: auto;
        }

        .back-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(16, 195, 176, 0.4);
        }
    </style>
</head>
<body>

    <div class="container">
        <div class="header">
            <h1>üéØ Sales Outreach Generator</h1>
            <p>AI-Powered Email & LinkedIn Messages Using Your Methodology</p>
            <div style="margin-top: 15px; display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                <a href="index.html" class="back-btn">
                    ‚Üê Back to Dashboard
                </a>

                <!-- Notification Bell -->
                <button id="notification-bell" onclick="toggleNotificationPanel()" style="padding: 10px 18px; background: linear-gradient(135deg, var(--brand-gold), var(--brand-yellow)); color: var(--brand-navy); border: none; border-radius: 25px; font-size: 18px; cursor: pointer; transition: all 0.2s ease; box-shadow: 0 2px 8px rgba(244, 176, 58, 0.3); position: relative;">
                    üîî
                    <span id="notification-badge" style="position: absolute; top: 3px; right: 3px; background: var(--brand-pink); color: white; border-radius: 50%; width: 18px; height: 18px; display: none; align-items: center; justify-content: center; font-size: 10px; font-weight: bold;"></span>
                </button>
            </div>
        </div>

        <div id="alert-container"></div>

        <div class="grid">
            <!-- Input Form -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Prospect Details</h2>
                    <span>üìù</span>
                </div>

                <!-- Methodology Display -->
                <div id="methodology-context" style="margin-bottom: 20px; padding: 15px; background: rgba(244, 176, 58, 0.1); border-radius: 10px; border-left: 4px solid var(--brand-gold);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <strong style="color: var(--brand-gold); font-size: 0.9rem;">üìö <span id="methodology-name">Sales Methodology</span></strong>
                        <a href="index.html" style="color: var(--brand-teal); font-size: 0.85rem; text-decoration: none;">Change ‚Üí</a>
                    </div>
                    <div id="methodology-description" style="font-size: 0.85rem; line-height: 1.6; opacity: 0.9;">
                        Select your sales methodology in the Setup section.
                    </div>
                </div>

                <!-- ICP Context Display -->
                <div id="icp-context" style="display: none; margin-bottom: 20px; padding: 15px; background: rgba(61, 224, 210, 0.1); border-radius: 10px; border-left: 4px solid var(--brand-teal);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <strong style="color: var(--brand-teal); font-size: 0.9rem;">üéØ Using Your ICP Profile</strong>
                        <a href="index.html#icp" style="color: var(--brand-gold); font-size: 0.85rem; text-decoration: none;">Edit ICP ‚Üí</a>
                    </div>
                    <div id="icp-summary" style="font-size: 0.85rem; line-height: 1.6; opacity: 0.9;"></div>
                </div>

                <div class="input-group">
                    <label>First Name *</label>
                    <input type="text" id="first-name" placeholder="Sarah">
                </div>

                <div class="input-group">
                    <label>Company *</label>
                    <input type="text" id="company" placeholder="ABC Housing Corp">
                </div>

                <div class="input-group">
                    <label>Industry</label>
                    <input type="text" id="industry" placeholder="Mixed-income housing providers">
                </div>

                <div class="input-group">
                    <label>Specific Pain Point (if known)</label>
                    <textarea id="pain-point" placeholder="Overwhelmed with manual maintenance requests..."></textarea>
                </div>

                <!-- Prospect Research Section -->
                <div style="margin: 20px 0; padding: 15px; background: rgba(244, 176, 58, 0.1); border-radius: 10px; border-left: 4px solid var(--brand-gold);">
                    <details>
                        <summary style="cursor: pointer; font-weight: 700; color: var(--brand-gold); font-size: 1rem; margin-bottom: 15px;">
                            üîç Prospect Research (Optional - Highly Personalized)
                        </summary>

                        <p style="font-size: 0.85rem; opacity: 0.8; margin-bottom: 15px;">
                            Add context from LinkedIn, their website, or social media to create hyper-personalized outreach that references specific details.
                        </p>

                        <div class="input-group">
                            <label>LinkedIn Profile Notes</label>
                            <textarea id="linkedin-notes" placeholder="e.g., Recently promoted to VP Sales, Posted about struggling with sales team consistency, Connected with John Smith (mutual connection), Previously worked at Salesforce" rows="3"></textarea>
                            <small style="opacity: 0.7; font-size: 0.85rem; margin-top: 5px; display: block;">
                                Recent posts, job changes, mutual connections, shared groups, etc.
                            </small>
                        </div>

                        <div class="input-group">
                            <label>Company Website / About Info</label>
                            <textarea id="website-notes" placeholder="e.g., Just launched new product line, Hiring 10 sales reps (job posting), Company mission focuses on customer success, Recently raised Series B funding" rows="3"></textarea>
                            <small style="opacity: 0.7; font-size: 0.85rem; margin-top: 5px; display: block;">
                                Company news, job postings, recent press releases, company values
                            </small>
                        </div>

                        <div class="input-group">
                            <label>Recent Activity / Social Media</label>
                            <textarea id="social-notes" placeholder="e.g., Commented on post about sales methodology, Shared article about sales coaching challenges, Attended [Conference Name] last week" rows="3"></textarea>
                            <small style="opacity: 0.7; font-size: 0.85rem; margin-top: 5px; display: block;">
                                Recent posts, comments, articles shared, events attended
                            </small>
                        </div>

                        <div class="input-group">
                            <label>Common Ground / Trigger Events</label>
                            <textarea id="common-ground" placeholder="e.g., Both from Hamilton area, Mutual connection: Jane Doe, Company just acquired competitor, Recent interview where they mentioned scaling challenges" rows="3"></textarea>
                            <small style="opacity: 0.7; font-size: 0.85rem; margin-top: 5px; display: block;">
                                Mutual connections, shared interests, trigger events, geographic ties
                            </small>
                        </div>

                        <div style="margin-top: 10px; padding: 10px; background: rgba(61, 224, 210, 0.1); border-radius: 8px; font-size: 0.85rem;">
                            üí° <strong>Pro Tip:</strong> Even 1-2 details makes your message stand out. Reference something specific from their profile or recent activity.
                        </div>
                    </details>
                </div>

                <div class="input-group">
                    <label>Channel</label>
                    <select id="channel-type" onchange="updateChannelOptions()">
                        <option value="email">Email Outreach</option>
                        <option value="linkedin">LinkedIn Outreach</option>
                    </select>
                </div>

                <div id="email-options">
                    <div class="input-group">
                        <label>Email Approach</label>
                        <select id="email-style">
                            <option value="soft">Soft Approach (Consultative)</option>
                            <option value="bold">Bold Approach (Direct Challenge)</option>
                        </select>
                    </div>

                    <div class="input-group">
                        <label>Call-to-Action</label>
                        <select id="cta-type">
                            <option value="calendar">Calendar Link</option>
                            <option value="reply">Reply "Curious"</option>
                            <option value="both">Both Options</option>
                        </select>
                    </div>
                </div>

                <div id="linkedin-options" style="display: none;">
                    <div class="input-group">
                        <label>LinkedIn Message Type</label>
                        <select id="linkedin-type">
                            <option value="connection">Connection Request</option>
                            <option value="dm">Direct Message (After Connected)</option>
                            <option value="group-post">Sales Methodology Group Post</option>
                            <option value="comment">Comment on Discussion</option>
                        </select>
                    </div>

                    <div class="input-group">
                        <label>Context (Optional)</label>
                        <textarea id="linkedin-context" placeholder="e.g., Saw your post about Pain Funnel challenges..."></textarea>
                    </div>
                </div>

                <button class="btn" onclick="generateEmails()">‚ú® Generate Emails</button>
                <button class="btn btn-secondary" onclick="generateVariations()">ü§ñ Generate AI Variations</button>
            </div>

            <!-- Email Output -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Generated Emails</h2>
                    <span>üìß</span>
                </div>

                <div class="tabs">
                    <div class="tab active" onclick="switchTab('subject')">Subject Lines</div>
                    <div class="tab" onclick="switchTab('email')">Email Body</div>
                    <div class="tab" onclick="switchTab('variations')">AI Variations</div>
                </div>

                <div id="output-container">
                    <p style="opacity: 0.7; text-align: center; padding: 40px;">Fill out the form and click "Generate Emails" to get started!</p>
                </div>
            </div>
        </div>

        <!-- A/B Testing Stats -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">üìä Email Performance Tracking</h2>
            </div>

            <div class="stats-grid">
                <div class="stat-box">
                    <div class="stat-value" id="total-sent">0</div>
                    <div class="stat-label">Emails Sent</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="response-rate">0%</div>
                    <div class="stat-label">Response Rate</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="best-subject">‚Äî</div>
                    <div class="stat-label">Best Subject Line</div>
                </div>
            </div>

            <div id="tracking-details"></div>
        </div>
    </div>

    <!-- Notification Panel (Hidden by default) -->
    <div id="notification-panel" style="display: none; position: fixed; top: 80px; right: 20px; width: 400px; max-width: calc(100vw - 40px); max-height: 600px; background: var(--card-bg); border: 2px solid var(--brand-teal); border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.5); z-index: 1000; overflow: hidden;">
        <div style="background: linear-gradient(135deg, var(--brand-teal), var(--brand-aqua)); padding: 15px; display: flex; justify-content: space-between; align-items: center;">
            <h3 style="margin: 0; color: white; font-size: 18px;">üì¨ Coaching Messages</h3>
            <div style="display: flex; gap: 10px;">
                <button id="mark-all-read-btn" onclick="markAllAsRead()" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 12px;">Mark All Read</button>
                <button onclick="toggleNotificationPanel()" style="background: transparent; border: none; color: white; font-size: 24px; cursor: pointer; line-height: 1;">√ó</button>
            </div>
        </div>

        <div id="notification-list" style="padding: 15px; overflow-y: auto; max-height: 520px;">
            <div style="text-align: center; padding: 40px 20px; opacity: 0.7;">
                <p>Loading messages...</p>
            </div>
        </div>
    </div>

    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://qwqlsbccwnwrdpcaccjz.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF3cWxzYmNjd253cmRwY2FjY2p6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUzMTA1MDQsImV4cCI6MjA4MDg4NjUwNH0.yWzSV2Nid_T1XiDE0RrskFob9mRUc-m6MbeIiT7huC4';

        let supabaseClient;
        let currentTab = 'subject';
        let generatedEmails = {};
        let currentVariations = [];

        // Sales Methodologies
        const METHODOLOGIES = {
            meddic: {
                name: 'MEDDIC/MEDDPICC',
                description: 'Qualify opportunities using Metrics, Economic Buyer, Decision Criteria, Decision Process, Identify Pain, Champion.',
                keyPrinciples: ['Metrics', 'Economic Buyer', 'Decision Criteria', 'Decision Process', 'Identify Pain', 'Champion'],
                examples: {
                    objection: 'Can you walk me through your decision criteria and timeline?',
                    pain: 'What metrics are you currently missing or struggling to hit?',
                    execution: 'Are your reps identifying the Economic Buyer and Champion in every deal?'
                }
            },
            challenger: {
                name: 'Challenger Sale',
                description: 'Teach prospects something new, tailor messaging to their situation, and take control of the sale.',
                keyPrinciples: ['Teach for Differentiation', 'Tailor for Resonance', 'Take Control'],
                examples: {
                    objection: 'Let me share something that might change how you think about this...',
                    pain: 'Most companies in your space don\'t realize...',
                    execution: 'Are your reps teaching insights or just pitching product?'
                }
            },
            sandler: {
                name: 'Sandler Selling System',
                description: 'Focus on Pain Funnel, Up-Front Contracts, Negative Reverse Selling, and Budget discussions.',
                keyPrinciples: ['Pain Funnel', 'Up-Front Contract', 'Negative Reverse Selling', 'Budget Before Presentation', 'Decision Before Presentation'],
                examples: {
                    objection: 'I get it. That\'s exactly why I called‚Äîto potentially give you back 20 hours a week. If I could show you how in 15 minutes, would that be worth it?',
                    pain: 'How is that impacting you?',
                    execution: 'Are your reps using the Pain Funnel and Up-Front Contracts consistently?'
                }
            },
            spin: {
                name: 'SPIN Selling',
                description: 'Use Situation, Problem, Implication, and Need-Payoff questions to uncover pain and build value.',
                keyPrinciples: ['Situation Questions', 'Problem Questions', 'Implication Questions', 'Need-Payoff Questions'],
                examples: {
                    objection: 'What would it mean for your team if we could solve this problem?',
                    pain: 'What problems are you experiencing with your current approach?',
                    execution: 'Are your reps asking Implication and Need-Payoff questions to build value?'
                }
            },
            gap: {
                name: 'Gap Selling',
                description: 'Focus on the gap between current state and future state. Problem-centric, not product-centric selling.',
                keyPrinciples: ['Current State Analysis', 'Future State Vision', 'Gap Identification', 'Impact of Inaction'],
                examples: {
                    objection: 'What\'s the cost of staying where you are today?',
                    pain: 'Where are you today vs. where do you need to be?',
                    execution: 'Are your reps clearly defining the Current State, Future State, and the Gap?'
                }
            }
        };

        // Get selected methodology from localStorage
        function getSelectedMethodology() {
            const methodologyKey = localStorage.getItem('salesMethodology') || 'sandler';
            return METHODOLOGIES[methodologyKey] || METHODOLOGIES.sandler;
        }

        function getMethodologyKey() {
            return localStorage.getItem('salesMethodology') || 'sandler';
        }

        // Initialize
        window.onload = function() {
            supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            loadEmailStats();
            loadICPData(); // Auto-populate from ICP
            displaySelectedMethodology(); // Show which methodology is being used
        };

        // Load ICP data from localStorage and auto-populate form
        function loadICPData() {
            const savedICP = localStorage.getItem('icp');
            if (savedICP) {
                try {
                    const icp = JSON.parse(savedICP);

                    // Auto-populate industry field
                    if (icp.industry) {
                        document.getElementById('industry').value = icp.industry;
                    }

                    // Auto-populate pain point field
                    if (icp.painPoints) {
                        document.getElementById('pain-point').value = icp.painPoints;
                    }

                    // Display ICP summary panel
                    const icpContext = document.getElementById('icp-context');
                    const icpSummary = document.getElementById('icp-summary');

                    if (icpContext && icpSummary) {
                        let summaryHTML = '';
                        if (icp.industry) summaryHTML += `<strong>Target:</strong> ${icp.industry}<br>`;
                        if (icp.companySize) summaryHTML += `<strong>Size:</strong> ${icp.companySize}<br>`;
                        if (icp.jobTitles) summaryHTML += `<strong>Titles:</strong> ${icp.jobTitles}<br>`;
                        if (icp.characteristics) {
                            const shortCharacteristics = icp.characteristics.substring(0, 150) + (icp.characteristics.length > 150 ? '...' : '');
                            summaryHTML += `<strong>Key Characteristics:</strong> ${shortCharacteristics}`;
                        }

                        if (summaryHTML) {
                            icpSummary.innerHTML = summaryHTML;
                            icpContext.style.display = 'block';
                        }
                    }

                    // Show success message
                    if (icp.industry || icp.painPoints) {
                        showAlert('‚úÖ ICP data loaded! Industry and Pain Points auto-filled from your profile.', 'success');
                    }
                } catch (error) {
                    console.error('Error loading ICP data:', error);
                }
            }
        }

        // Display selected methodology from setup
        function displaySelectedMethodology() {
            const methodology = getSelectedMethodology();
            const methodologyNameEl = document.getElementById('methodology-name');
            const methodologyDescEl = document.getElementById('methodology-description');

            if (methodologyNameEl && methodologyDescEl) {
                methodologyNameEl.textContent = methodology.name;
                methodologyDescEl.textContent = methodology.description;
            }
        }

        // Show alert
        function showAlert(message, type) {
            const container = document.getElementById('alert-container');
            container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => container.innerHTML = '', 5000);
        }

        // Get ICP context for generating personalized messages
        function getICPContext() {
            const savedICP = localStorage.getItem('icp');
            if (savedICP) {
                try {
                    return JSON.parse(savedICP);
                } catch (e) {
                    console.error('Error parsing ICP:', e);
                }
            }
            return null;
        }

        // Get prospect research context
        function getProspectContext() {
            return {
                linkedinNotes: document.getElementById('linkedin-notes')?.value.trim() || '',
                websiteNotes: document.getElementById('website-notes')?.value.trim() || '',
                socialNotes: document.getElementById('social-notes')?.value.trim() || '',
                commonGround: document.getElementById('common-ground')?.value.trim() || ''
            };
        }

        // Generate personalized opener based on prospect research
        function generatePersonalizedOpener(firstName, company, prospectContext) {
            const { linkedinNotes, websiteNotes, socialNotes, commonGround } = prospectContext;

            // Priority: Common Ground > Recent Activity > LinkedIn > Website
            if (commonGround) {
                return `Hi ${firstName},\n\n${commonGround}\n\n`;
            }

            if (socialNotes) {
                return `Hi ${firstName},\n\nI noticed ${socialNotes.toLowerCase()}\n\n`;
            }

            if (linkedinNotes) {
                // Extract first meaningful detail from LinkedIn notes
                const firstDetail = linkedinNotes.split(',')[0].trim();
                return `Hi ${firstName},\n\nI saw that ${firstDetail.toLowerCase()}.\n\n`;
            }

            if (websiteNotes) {
                const firstDetail = websiteNotes.split(',')[0].trim();
                return `Hi ${firstName},\n\nI noticed ${company} ${firstDetail.toLowerCase()}.\n\n`;
            }

            // Default opener if no research provided
            return `Hi ${firstName},\n\n`;
        }

        // Update channel options
        function updateChannelOptions() {
            const channel = document.getElementById('channel-type').value;
            if (channel === 'linkedin') {
                document.getElementById('email-options').style.display = 'none';
                document.getElementById('linkedin-options').style.display = 'block';
            } else {
                document.getElementById('email-options').style.display = 'block';
                document.getElementById('linkedin-options').style.display = 'none';
            }
        }

        // Switch tabs
        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            displayCurrentTab();
        }

        // Generate emails from templates
        function generateEmails() {
            const firstName = document.getElementById('first-name').value.trim();
            const company = document.getElementById('company').value.trim();
            const industry = document.getElementById('industry').value.trim() || 'your industry';
            const painPoint = document.getElementById('pain-point').value.trim();
            const channel = document.getElementById('channel-type').value;

            // Get prospect research context
            const prospectContext = getProspectContext();

            if (!firstName || !company) {
                showAlert('Please enter at least First Name and Company', 'error');
                return;
            }

            if (channel === 'linkedin') {
                generateLinkedInMessages(firstName, company, industry, painPoint, prospectContext);
            } else {
                const style = document.getElementById('email-style').value;
                const ctaType = document.getElementById('cta-type').value;
                const icp = getICPContext();

                // Get methodology for personalization
                const methodology = getSelectedMethodology();

                // Generate subject lines with ICP context
                let subjectLines = [
                    `${firstName} - Are your reps executing ${methodology.name} or just talking about it?`,
                    `Quick question about ${company}'s ${methodology.name} execution`,
                    `${company} - ${methodology.name} coaching that doesn't require a $10K consultant`
                ];

                // Add ICP-specific subject lines if available
                if (icp) {
                    if (icp.painPoints) {
                        const painShort = icp.painPoints.split(',')[0].trim();
                        subjectLines.push(`${firstName} - Solving ${painShort} at ${company}?`);
                    }
                    if (icp.industry) {
                        subjectLines.push(`${company} - ${icp.industry} methodology execution`);
                    }
                }

                // Generate email body
                const emailBody = style === 'soft' ? generateSoftEmail(firstName, company, industry, painPoint, ctaType, prospectContext) : generateBoldEmail(firstName, company, industry, painPoint, ctaType, prospectContext);

                generatedEmails = {
                    subjectLines,
                    emailBody,
                    style,
                    firstName,
                    company,
                    channel: 'email'
                };

                currentTab = 'subject';
                displayCurrentTab();
                showAlert('‚úÖ Emails generated! Click tabs to see subject lines, body, and request AI variations.', 'success');
            }
        }

        // Generate LinkedIn messages
        function generateLinkedInMessages(firstName, company, industry, painPoint, prospectContext) {
            const linkedinType = document.getElementById('linkedin-type').value;
            const context = document.getElementById('linkedin-context').value.trim();

            let messages = {};

            switch(linkedinType) {
                case 'connection':
                    messages = {
                        subjectLines: ['LinkedIn Connection Request'],
                        emailBody: generateLinkedInConnection(firstName, company, context, prospectContext)
                    };
                    break;
                case 'dm':
                    messages = {
                        subjectLines: ['LinkedIn Direct Message'],
                        emailBody: generateLinkedInDM(firstName, company, industry, painPoint, context, prospectContext)
                    };
                    break;
                case 'group-post':
                    const methodologyGroupPost = getSelectedMethodology();
                    messages = {
                        subjectLines: [`${methodologyGroupPost.name} Group Post`],
                        emailBody: generateLinkedInGroupPost()
                    };
                    break;
                case 'comment':
                    messages = {
                        subjectLines: ['Discussion Comment'],
                        emailBody: generateLinkedInComment(context)
                    };
                    break;
            }

            generatedEmails = {
                ...messages,
                style: linkedinType,
                firstName,
                company,
                channel: 'linkedin'
            };

            currentTab = 'email';
            displayCurrentTab();
            showAlert('‚úÖ LinkedIn message generated!', 'success');
        }

        // Generate LinkedIn connection request
        function generateLinkedInConnection(firstName, company, context, prospectContext) {
            const icp = getICPContext();
            let industryContext = '';

            // Get methodology
            const methodology = getSelectedMethodology();

            // Add ICP-specific context
            if (icp && icp.industry) {
                industryContext = ` I help sales leaders in ${icp.industry} execute ${methodology.name} in real conversations.`;
            } else {
                industryContext = ` I help sales teams execute ${methodology.name} in real conversations.`;
            }

            // Use prospect research for personalized connection
            const hasProspectResearch = prospectContext && (prospectContext.linkedinNotes || prospectContext.commonGround);

            if (hasProspectResearch) {
                // Highly personalized connection request
                let personalNote = '';
                if (prospectContext.commonGround) {
                    personalNote = prospectContext.commonGround;
                } else if (prospectContext.linkedinNotes) {
                    personalNote = prospectContext.linkedinNotes.split(',')[0].trim();
                }

                return `Hi ${firstName},\n\n${personalNote}\n\n${industryContext} Would love to connect and share insights!\n\nBest,\nJohn`;
            }

            if (context) {
                return `Hi ${firstName},\n\n${context}\n\n${industryContext} Would love to connect and share insights!\n\nBest,\nJohn`;
            } else {
                return `Hi ${firstName},\n\nSaw you're with ${company}.${industryContext} Would love to connect.\n\nLooking forward to sharing insights!\n\nBest,\nJohn`;
            }
        }

        // Generate LinkedIn DM (after connection)
        function generateLinkedInDM(firstName, company, industry, painPoint, context, prospectContext) {
            const icp = getICPContext();

            // Use ICP data to personalize
            let targetIndustry = industry;
            let specificPain = '';
            let qualifierNote = '';

            if (icp) {
                // Use ICP industry if not provided
                if (!industry || industry === 'your industry') {
                    targetIndustry = icp.industry || 'your industry';
                }

                // Use ICP pain points
                if (painPoint) {
                    specificPain = `\n\nI know ${targetIndustry} companies often face: ${painPoint}`;
                } else if (icp.painPoints) {
                    specificPain = `\n\nI know ${targetIndustry} companies often face: ${icp.painPoints}`;
                }

                // Add company size/title qualifier
                if (icp.companySize || icp.jobTitles) {
                    qualifierNote = `\n\n(This typically resonates with ${icp.companySize ? icp.companySize + ' teams' : 'teams'}${icp.jobTitles ? ' - especially ' + icp.jobTitles : ''})`;
                }
            }

            // Use prospect research for opening
            let dmOpener = '';
            const hasProspectResearch = prospectContext && (prospectContext.linkedinNotes || prospectContext.socialNotes || prospectContext.websiteNotes || prospectContext.commonGround);

            if (hasProspectResearch) {
                // Build personalized opener from research
                if (prospectContext.socialNotes) {
                    dmOpener = `\n\nThanks for connecting! I saw that ${prospectContext.socialNotes.toLowerCase()}\n\n`;
                } else if (prospectContext.linkedinNotes) {
                    const detail = prospectContext.linkedinNotes.split(',')[0].trim().toLowerCase();
                    dmOpener = `\n\nThanks for connecting! I noticed ${detail}.\n\n`;
                } else if (prospectContext.websiteNotes) {
                    const detail = prospectContext.websiteNotes.split(',')[0].trim().toLowerCase();
                    dmOpener = `\n\nThanks for connecting! I saw that ${company} ${detail}.\n\n`;
                } else if (prospectContext.commonGround) {
                    dmOpener = `\n\n${prospectContext.commonGround}\n\nThanks for connecting!\n\n`;
                }
            } else {
                // Default opener
                const contextLine = context ? `\n\n${context}\n\n` : '\n\n';
                dmOpener = `${contextLine}Thanks for connecting! I noticed you're focused on ${targetIndustry}.\n\n`;
            }

            // Get methodology
            const methodology = getSelectedMethodology();

            return `Hi ${firstName},${dmOpener}

Quick question: After your team gets ${methodology.name} training, do you have a system to ensure they're actually EXECUTING it in real calls?${specificPain}

Most sales leaders I talk to face the same challenge:
- Reps learn ${methodology.name} ‚Üí Get excited ‚Üí Week 1-2 they use it ‚Üí Week 4+ back to old habits

I built an AI coaching tool that analyzes every call and gives reps specific ${methodology.name} scripts to use next time.

**Example:** When prospect says "We're too busy," instead of ending the call, it coaches:
> "Try: 'I get it. That's exactly why I called‚Äîto give you back 20 hours/week. Worth 15 min to explore?'"

Worth a quick look? I can send you a 2-min demo or we could jump on a quick call.${qualifierNote}

Either way, happy to be connected!

Best,
John`;
        }

        // Generate LinkedIn group post
        function generateLinkedInGroupPost() {
            const icp = getICPContext();
            let industryContext = '';
            let painContext = '';

            if (icp) {
                if (icp.industry) {
                    industryContext = ` (especially for ${icp.industry} teams)`;
                }
                if (icp.painPoints) {
                    painContext = `\n\nThe biggest challenge I hear: ${icp.painPoints}\n`;
                }
            }

            // Get methodology
            const methodology = getSelectedMethodology();

            return `After ${methodology.name} training, we had a problem${industryContext}:

Reps KNEW the methodology but weren't EXECUTING it in real calls.${painContext}

We tried:
‚ùå More role-playing ‚Üí Didn't stick
‚ùå Weekly call reviews ‚Üí Only covered 2-3 calls
‚ùå Reminder emails ‚Üí Ignored

Then we built an AI coach that analyzes EVERY call and gives specific ${methodology.name} scripts.

Example: When prospect says "We're too busy," AI coaches:
**"Try: '${methodology.examples.objection}'"**

Result: Reps now USE what they learned.

**Question for the group:** How do you ensure your team executes ${methodology.name} 60+ days after training?

What's working for you?

---

P.S. - Happy to share more about the AI tool if anyone's curious. DM me.`;
        }

        // Generate LinkedIn comment
        function generateLinkedInComment(context) {
            const icp = getICPContext();
            const methodology = getSelectedMethodology();
            let industryNote = '';

            // Add industry context from ICP
            if (icp && icp.industry) {
                industryNote = ` Especially relevant for ${icp.industry}.`;
            }

            if (!context) {
                return `Great point! The gap between ${methodology.name} training and execution is massive.${industryNote} We built an AI tool that gives reps specific scripts after every call. Game-changer for reinforcement.`;
            }

            return `Totally agree with this.\n\n${context}\n\nWe solved this with an AI coach that analyzes calls and gives ${methodology.name}-specific scripts. Reps get feedback on EVERY call, not just the ones managers review.${industryNote}\n\nHappy to share more if useful!`;
        }

        // Generate soft approach email
        function generateSoftEmail(firstName, company, industry, painPoint, ctaType, prospectContext) {
            const ctaText = getCTAText(ctaType);
            const icp = getICPContext();

            // Use ICP data to personalize the email
            let targetIndustry = industry;
            let specificPainPoints = '';
            let qualifierContext = '';

            if (icp) {
                // Use ICP industry if no industry provided
                if (!industry || industry === 'your industry') {
                    targetIndustry = icp.industry || 'your industry';
                }

                // Use ICP pain points to customize messaging
                if (painPoint) {
                    specificPainPoints = painPoint;
                } else if (icp.painPoints) {
                    specificPainPoints = icp.painPoints;
                }

                // Add qualifier context from ICP characteristics
                if (icp.characteristics) {
                    qualifierContext = `\n\n**Quick qualifier:** This works best for companies that ${icp.characteristics.toLowerCase().substring(0, 150)}...`;
                }
            }

            // Build pain points list
            let painPointsList = `- Feature-dump instead of using the Pain Funnel
- Skip Up-Front Contracts
- Talk 60% of the call instead of 30%`;

            if (specificPainPoints) {
                painPointsList = `- ${specificPainPoints}
- Inconsistent methodology execution
- Limited coaching coverage across all calls`;
            }

            // Use prospect research for personalized opener
            const hasProspectResearch = prospectContext && (prospectContext.linkedinNotes || prospectContext.websiteNotes || prospectContext.socialNotes || prospectContext.commonGround);
            let opener = '';

            if (hasProspectResearch) {
                // Generate highly personalized opener
                opener = generatePersonalizedOpener(firstName, company, prospectContext);
            } else {
                // Default opener
                opener = `Hi ${firstName},\n\nI know I'm catching you cold, so I'll be brief.\n\n`;
            }

            // Get methodology for personalization
            const methodology = getSelectedMethodology();
            const methodologyExample = methodology.examples.objection;

            return `${opener}I help sales leaders at ${targetIndustry} solve a specific problem:

**Their reps know ${methodology.name} methodology, but they're not executing it in real conversations.**

The result? ${methodology.name}-trained teams that still:
${painPointsList}

I built an AI-powered coaching system that analyzes EVERY sales call and gives reps **specific ${methodology.name} scripts** to use next time‚Äînot generic feedback like "build more rapport."

**Example:** When a prospect says "We're too busy," instead of ending the call, the system coaches:

> *"Try: '${methodologyExample}'"*

**Just curious:** ${methodology.examples.execution}

If you don't, would it make sense to spend 15 minutes exploring whether this could help ${company} hit quota more consistently?${qualifierContext}

Worst case, we'll both know it's not a fit.

Fair enough?

${ctaText}

Best,
**John Cunningham**
AI Advantage Solutions
Hamilton, ON
[Phone] | [Calendar Link]

P.S. - I've attached a one-pager showing exactly how it works. If you're curious, you can also see a live demo of your own call being analyzed with ${methodology.name} coaching: [Calendar Link]`;
        }

        // Generate bold approach email
        function generateBoldEmail(firstName, company, industry, painPoint, ctaType, prospectContext) {
            const ctaText = getCTAText(ctaType);
            const icp = getICPContext();

            // Use ICP data to personalize the email
            let targetIndustry = industry;
            let specificPainPoint = '';
            let icpQualifier = '';

            if (icp) {
                // Use ICP industry if no industry provided
                if (!industry || industry === 'your industry') {
                    targetIndustry = icp.industry || 'your industry';
                }

                // Use ICP pain points
                if (painPoint) {
                    specificPainPoint = painPoint;
                } else if (icp.painPoints) {
                    specificPainPoint = icp.painPoints;
                }

                // Add ICP qualifier at the end
                if (icp.companySize || icp.jobTitles) {
                    icpQualifier = `\n\n**P.S.** - This works best for ${icp.companySize ? icp.companySize + ' companies' : 'companies'}${icp.jobTitles ? ' where ' + icp.jobTitles + ' are looking to' : ' looking to'} maximize their sales methodology investment.`;
                }
            }

            let painPointContext = specificPainPoint ? `\n\nI know teams at ${targetIndustry} are dealing with: ${specificPainPoint}` : '';

            // Use prospect research for personalized opener
            const hasProspectResearch = prospectContext && (prospectContext.linkedinNotes || prospectContext.websiteNotes || prospectContext.socialNotes || prospectContext.commonGround);
            let opener = '';

            if (hasProspectResearch) {
                // Generate highly personalized opener
                opener = generatePersonalizedOpener(firstName, company, prospectContext);
            } else {
                // Default bold opener
                opener = `Hi ${firstName},\n\nThat's probably a bold subject line, but hear me out.\n\n`;
            }

            // Get methodology for personalization
            const methodology = getSelectedMethodology();
            const methodologyPrinciple = methodology.keyPrinciples[0] || 'key principles';

            return `${opener}

Most sales leaders invest in ${methodology.name} training (or already have ${methodology.name}-trained reps), but here's what happens:

- **Week 1:** Reps are fired up, taking notes
- **Week 4:** They're using 30% of what they learned
- **Week 12:** Back to old habits‚Äînot applying ${methodologyPrinciple}

The problem isn't the training. It's **reinforcement**.${painPointContext}

I built an AI system that listens to every call and gives reps **specific ${methodology.name} scripts** for next time.

Example: When a prospect says "Send me some information," instead of just sending it, the AI coaches:

> *"Try: '${methodology.examples.objection}'"*

**Question:** Would it be worth 15 minutes to see how this could help ${company} actually execute the ${methodology.name} methodology you've already invested in?

${ctaText}

Best,
**John Cunningham**
AI Advantage Solutions
Hamilton, ON
[Phone] | [Calendar Link]${icpQualifier}`;
        }

        // Get CTA text based on type
        function getCTAText(ctaType) {
            if (ctaType === 'calendar') {
                return 'If yes, grab 15 minutes here: [Calendar Link]';
            } else if (ctaType === 'reply') {
                return 'If yes, just reply "curious" and I\'ll send you a 2-minute demo video.\nIf no, reply "not a fit" and I won\'t follow up.';
            } else {
                return 'If yes, grab 15 minutes here: [Calendar Link]\nOr just reply "curious" for a quick demo video.\nIf no, reply "not a fit" and I won\'t follow up.';
            }
        }

        // Display current tab content
        function displayCurrentTab() {
            const output = document.getElementById('output-container');

            if (!generatedEmails.subjectLines) {
                return;
            }

            if (currentTab === 'subject') {
                output.innerHTML = `
                    <div class="variations-container">
                        ${generatedEmails.subjectLines.map((subject, i) => `
                            <div class="variation">
                                <div class="variation-label">Subject Line ${i + 1}</div>
                                <div style="color: var(--brand-gold); font-weight: 600; margin-bottom: 10px;">${subject}</div>
                                <button class="btn copy-btn" onclick="copyText('${subject.replace(/'/g, "\\'")}', 'Subject line copied!')">üìã Copy</button>
                            </div>
                        `).join('')}
                    </div>
                `;
            } else if (currentTab === 'email') {
                output.innerHTML = `
                    <div class="email-output">
                        <div class="email-subject">Subject: ${generatedEmails.subjectLines[0]}</div>
                        <div class="email-body">${generatedEmails.emailBody}</div>
                        <button class="btn copy-btn" onclick="copyEmailToClipboard()">üìã Copy Full Email</button>
                        <button class="btn copy-btn btn-secondary" onclick="trackEmailSent()">‚úÖ Mark as Sent</button>
                    </div>
                `;
            } else if (currentTab === 'variations') {
                output.innerHTML = `
                    <div id="variations-output">
                        <p style="opacity: 0.7; text-align: center; padding: 20px;">Click "Generate AI Variations" to get Claude-powered email alternatives!</p>
                    </div>
                `;
            }
        }

        // Generate smart variations using different methodology strategies
        function generateVariations() {
            if (!generatedEmails.emailBody) {
                showAlert('Please generate base emails first!', 'error');
                return;
            }

            const methodology = getSelectedMethodology();

            showAlert('‚ú® Generating strategic variations...', 'success');
            currentTab = 'variations';

            // Update tab UI
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab')[2].classList.add('active');

            // First display the variations tab to create the container
            displayCurrentTab();

            // Now get the variations output element
            const variationsOutput = document.getElementById('variations-output');
            if (!variationsOutput) {
                console.error('Could not find variations-output element');
                return;
            }

            variationsOutput.innerHTML = `<div class="loading">Creating ${methodology.name}-based variations...</div>`;

            // Create intelligent variations based on selected methodology principles
            const principle1 = methodology.keyPrinciples[0] || 'key principles';
            const principle2 = methodology.keyPrinciples[1] || 'best practices';

            currentVariations = [
                {
                    title: `Variation 1: Direct & Consultative`,
                    email: `Hi ${generatedEmails.firstName},

I'm not sure if this is relevant to ${generatedEmails.company}, but I'll take 30 seconds.

Most sales leaders tell me their reps learned ${methodology.name}... but don't actually USE it in real conversations.

Sound familiar?

If it does, I built something that might help: An AI coach that gives your reps specific ${methodology.name} scripts after every call.

Example: When a prospect says "We're too busy," it coaches:
> "Try: '${methodology.examples.objection}'"

If this isn't a fit, no worries. But if it is, would 15 minutes make sense to explore?

Worst case, you'll tell me "not a fit" and we'll both move on.

Fair enough?

Best,
John Cunningham
AI Advantage Solutions
[Calendar Link]`
                },
                {
                    title: `Variation 2: Problem-Focused`,
                    email: `Hi ${generatedEmails.firstName},

Quick question about ${generatedEmails.company}:

After your team gets ${methodology.name} training, how long does it take before they're back to old habits?

Here's what I typically hear:
- Week 1-2: They apply ${principle1}
- Week 4: Using maybe 30% of it
- Week 8: Back to old habits

The problem? No real-time reinforcement.

I built an AI system that analyzes EVERY call and coaches reps with specific ${methodology.name} scripts.

**Here's my question:** If I could show you a way to make ${methodology.name} stick for 90+ days instead of 14 days, would 15 minutes be a good investment?

If yes: [Calendar Link]
If no: Just tell me "not interested" and I'll stop here.

Best,
John Cunningham
AI Advantage Solutions
Hamilton, ON`
                },
                {
                    title: "Variation 3: Ultra-Brief (Mobile Optimized)",
                    email: `${generatedEmails.firstName} -

Problem: Your reps learned ${methodology.name} but don't execute it.

Solution: AI coach gives them specific scripts after EVERY call.

Example:
Prospect: "We're too busy"
AI: "Try: '${methodology.examples.objection}'"

Worth a 15-min demo?

[Calendar Link]

John Cunningham
AI Advantage Solutions`
                },
                {
                    title: "Variation 4: Social Proof Version",
                    email: `Hi ${generatedEmails.firstName},

I work with ${methodology.name}-trained sales teams at companies like ${generatedEmails.company}.

Common challenge they share: Reps know the methodology but don't execute it consistently.

We solved this with an AI coaching system that:
- Analyzes 100% of calls (not just 2-3/week)
- Gives reps exact ${methodology.name} scripts for next time
- Reinforces ${principle1}, ${principle2}, and more

**Real example:** When prospect says "Send me info," AI coaches:
> "Try: '${methodology.examples.objection}'"

Teams using this are seeing 40%+ improvement in ${methodology.name} execution scores.

Would it make sense to see if this could work for ${generatedEmails.company}?

15-minute demo: [Calendar Link]

Best,
John Cunningham
AI Advantage Solutions
Hamilton, ON`
                }
            ];

            // Render variations with safer onclick handlers
            let html = '<div class="variations-container">';
            currentVariations.forEach((v, i) => {
                html += `
                    <div class="variation">
                        <div class="variation-label">${v.title}</div>
                        <div class="email-body" style="margin-top: 10px; white-space: pre-wrap;">${v.email}</div>
                        <button class="btn copy-btn" onclick="copyVariation(${i})">üìã Copy This Version</button>
                    </div>
                `;
            });
            html += '</div>';

            variationsOutput.innerHTML = html;
            showAlert('‚úÖ 4 strategic variations generated!', 'success');
        }

        // Copy a variation by index
        function copyVariation(index) {
            if (currentVariations[index]) {
                copyText(currentVariations[index].email, `Variation ${index + 1} copied!`);
            }
        }

        // Copy text to clipboard
        function copyText(text, message) {
            navigator.clipboard.writeText(text).then(() => {
                showAlert(message, 'success');
            });
        }

        // Copy full email to clipboard
        function copyEmailToClipboard() {
            const fullEmail = `Subject: ${generatedEmails.subjectLines[0]}\n\n${generatedEmails.emailBody}`;
            copyText(fullEmail, 'üìß Full email copied to clipboard!');
        }

        // Track email as sent
        async function trackEmailSent() {
            if (!generatedEmails.company) return;

            try {
                await supabaseClient.from('Email_Tracking').insert({
                    prospect_name: generatedEmails.firstName,
                    prospect_company: generatedEmails.company,
                    subject_line: generatedEmails.subjectLines[0],
                    email_style: generatedEmails.style,
                    sent_date: new Date().toISOString().split('T')[0],
                    status: 'sent'
                });

                showAlert('‚úÖ Email marked as sent and tracked!', 'success');
                loadEmailStats();
            } catch (error) {
                console.error('Tracking error:', error);
                showAlert('‚ö†Ô∏è Email not tracked (table may not exist yet)', 'error');
            }
        }

        // Load email statistics
        async function loadEmailStats() {
            try {
                const { data, error } = await supabaseClient
                    .from('Email_Tracking')
                    .select('*')
                    .order('sent_date', { ascending: false });

                if (error) throw error;

                const totalSent = data.length;
                const responded = data.filter(e => e.status === 'responded' || e.status === 'booked').length;
                const responseRate = totalSent > 0 ? ((responded / totalSent) * 100).toFixed(1) : 0;

                // Find best subject line
                const subjectStats = {};
                data.forEach(email => {
                    if (!subjectStats[email.subject_line]) {
                        subjectStats[email.subject_line] = { sent: 0, responded: 0 };
                    }
                    subjectStats[email.subject_line].sent++;
                    if (email.status === 'responded' || email.status === 'booked') {
                        subjectStats[email.subject_line].responded++;
                    }
                });

                let bestSubject = '‚Äî';
                let bestRate = 0;
                Object.entries(subjectStats).forEach(([subject, stats]) => {
                    const rate = stats.responded / stats.sent;
                    if (rate > bestRate && stats.sent >= 2) { // Only count if sent at least 2 times
                        bestRate = rate;
                        bestSubject = subject.substring(0, 30) + '...';
                    }
                });

                document.getElementById('total-sent').textContent = totalSent;
                document.getElementById('response-rate').textContent = responseRate + '%';
                document.getElementById('best-subject').textContent = bestSubject;

                // Show recent emails with status update options
                const trackingDetails = document.getElementById('tracking-details');
                if (data.length > 0) {
                    trackingDetails.innerHTML = `
                        <div style="margin-top: 20px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 20px;">
                            <h3 style="color: var(--brand-aqua); font-size: 1rem; margin-bottom: 15px;">Recent Emails (Click to Update Status)</h3>
                            <div style="display: grid; gap: 10px;">
                                ${data.slice(0, 10).map(email => `
                                    <div style="background: rgba(255,255,255,0.05); padding: 12px; border-radius: 8px; display: grid; grid-template-columns: 1fr auto; gap: 10px; align-items: center;">
                                        <div>
                                            <div style="font-weight: 600; color: var(--brand-gold); font-size: 0.9rem;">${email.prospect_name} - ${email.prospect_company}</div>
                                            <div style="font-size: 0.8rem; opacity: 0.7; margin-top: 3px;">${email.sent_date} ‚Ä¢ ${email.subject_line.substring(0, 40)}...</div>
                                        </div>
                                        <div style="display: flex; gap: 5px;">
                                            <select id="status-${email.id}" onchange="updateEmailStatus('${email.id}')" style="padding: 6px; border-radius: 6px; background: var(--input-bg); color: var(--brand-teal); border: 1px solid rgba(255,255,255,0.1); font-size: 0.85rem;">
                                                <option value="sent" ${email.status === 'sent' ? 'selected' : ''}>üì§ Sent</option>
                                                <option value="opened" ${email.status === 'opened' ? 'selected' : ''}>üëÄ Opened</option>
                                                <option value="responded" ${email.status === 'responded' ? 'selected' : ''}>üí¨ Responded</option>
                                                <option value="booked" ${email.status === 'booked' ? 'selected' : ''}>‚úÖ Meeting Booked</option>
                                                <option value="no_response" ${email.status === 'no_response' ? 'selected' : ''}>‚ùå No Response</option>
                                            </select>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                } else {
                    trackingDetails.innerHTML = `
                        <div style="margin-top: 20px; padding: 15px; background: rgba(16, 195, 176, 0.1); border-radius: 8px; text-align: center;">
                            <p style="opacity: 0.8;">No emails tracked yet. Click "Mark as Sent" after generating emails to start tracking!</p>
                        </div>
                    `;
                }

            } catch (error) {
                console.error('Stats error:', error);
                document.getElementById('tracking-details').innerHTML = `
                    <div style="margin-top: 20px; padding: 15px; background: rgba(230, 69, 99, 0.1); border-radius: 8px; text-align: center;">
                        <p style="color: var(--brand-pink);">Email tracking not set up yet. Run the SQL schema to create the Email_Tracking table.</p>
                    </div>
                `;
            }
        }

        // Update email status
        async function updateEmailStatus(emailId) {
            const newStatus = document.getElementById(`status-${emailId}`).value;

            try {
                const { error } = await supabaseClient
                    .from('Email_Tracking')
                    .update({
                        status: newStatus,
                        response_date: newStatus === 'responded' || newStatus === 'booked' ? new Date().toISOString().split('T')[0] : null
                    })
                    .eq('id', emailId);

                if (error) throw error;

                showAlert(`‚úÖ Status updated to: ${newStatus}`, 'success');
                loadEmailStats(); // Refresh stats

            } catch (error) {
                console.error('Update error:', error);
                showAlert('‚ö†Ô∏è Failed to update status', 'error');
            }
        }

        // ============================================
        // NOTIFICATION FUNCTIONS
        // ============================================

        let currentUser = null;

        async function fetchUnreadCount() {
            try {
                const { data, error } = await supabaseClient.rpc('get_unread_message_count');

                if (error) throw error;

                const badge = document.getElementById('notification-badge');
                if (badge) {
                    if (data > 0) {
                        badge.textContent = data > 9 ? '9+' : data;
                        badge.style.display = 'flex';
                    } else {
                        badge.style.display = 'none';
                    }
                }

                return data;
            } catch (error) {
                console.error('Error fetching unread count:', error);
                return 0;
            }
        }

        async function fetchMessages() {
            try {
                const { data, error } = await supabaseClient
                    .from('User_Messages')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(50);

                if (error) throw error;

                displayMessages(data || []);
                return data;
            } catch (error) {
                console.error('Error fetching messages:', error);
                displayMessages([]);
            }
        }

        function displayMessages(messages) {
            const container = document.getElementById('notification-list');

            if (!messages || messages.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px; opacity: 0.7;">
                        <p style="font-size: 48px; margin-bottom: 10px;">üì≠</p>
                        <p>No coaching messages yet</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = messages.map(msg => {
                const date = new Date(msg.created_at);
                const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                const timeStr = date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });

                const priorityColors = {
                    high: 'var(--brand-pink)',
                    medium: 'var(--brand-gold)',
                    low: 'var(--brand-teal)'
                };

                const priorityEmoji = {
                    high: 'üî¥',
                    medium: 'üü°',
                    low: 'üü¢'
                };

                return `
                    <div class="message-item" data-message-id="${msg.id}" style="
                        background: ${msg.is_read ? 'rgba(255,255,255,0.03)' : 'rgba(16, 195, 176, 0.1)'};
                        border: 1px solid ${msg.is_read ? 'rgba(255,255,255,0.1)' : 'var(--brand-teal)'};
                        border-radius: 10px;
                        padding: 15px;
                        margin-bottom: 12px;
                        cursor: pointer;
                        transition: all 0.2s ease;
                    " onclick="viewMessage('${msg.id}', ${!msg.is_read})">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                            <div style="flex: 1;">
                                <span style="background: ${priorityColors[msg.priority]}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: bold; margin-right: 8px;">
                                    ${priorityEmoji[msg.priority]} ${msg.priority.toUpperCase()}
                                </span>
                                ${!msg.is_read ? '<span style="background: var(--brand-pink); color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: bold;">NEW</span>' : ''}
                            </div>
                            <span style="font-size: 12px; opacity: 0.7; white-space: nowrap;">${dateStr} ${timeStr}</span>
                        </div>

                        <h4 style="margin: 8px 0; color: var(--brand-teal); font-size: 14px;">${msg.subject}</h4>

                        ${msg.related_metric ? `<div style="font-size: 12px; opacity: 0.7; margin-bottom: 8px;">üìä ${msg.related_metric}</div>` : ''}

                        <p style="margin: 0; font-size: 13px; opacity: 0.9; line-height: 1.5; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden;">
                            ${msg.message_body.substring(0, 150)}${msg.message_body.length > 150 ? '...' : ''}
                        </p>

                        <div style="margin-top: 10px; font-size: 11px; opacity: 0.6;">
                            From: ${msg.from_name || msg.from_email}
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function viewMessage(messageId, isUnread) {
            try {
                // Fetch full message
                const { data: msg, error } = await supabaseClient
                    .from('Coaching_Messages')
                    .select('*, from_user:from_user_id(email, raw_user_meta_data)')
                    .eq('id', messageId)
                    .single();

                if (error) throw error;

                // Mark as read if unread
                if (isUnread) {
                    await supabaseClient.rpc('mark_message_as_read', { message_id: messageId });
                    await fetchUnreadCount();
                    await fetchMessages(); // Refresh list
                }

                // Display full message in modal
                const date = new Date(msg.created_at);
                const dateStr = date.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
                const timeStr = date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });

                alert(`üì¨ ${msg.subject}\n\n${msg.message_body}\n\n---\nFrom: ${msg.from_user?.raw_user_meta_data?.full_name || msg.from_user?.email}\nDate: ${dateStr} at ${timeStr}\nMetric: ${msg.related_metric || 'General'}`);

            } catch (error) {
                console.error('Error viewing message:', error);
                alert('Error loading message. Please try again.');
            }
        }

        async function markAllAsRead() {
            try {
                const { data, error } = await supabaseClient.rpc('mark_all_messages_as_read');

                if (error) throw error;

                if (data > 0) {
                    await fetchUnreadCount();
                    await fetchMessages();
                    alert(`‚úÖ Marked ${data} message${data > 1 ? 's' : ''} as read`);
                } else {
                    alert('No unread messages');
                }
            } catch (error) {
                console.error('Error marking all as read:', error);
                alert('Error marking messages as read. Please try again.');
            }
        }

        function toggleNotificationPanel() {
            const panel = document.getElementById('notification-panel');
            const isHidden = panel.style.display === 'none';

            if (isHidden) {
                panel.style.display = 'block';
                fetchMessages(); // Load messages when opening
            } else {
                panel.style.display = 'none';
            }
        }

        // Initialize notifications on page load
        async function initNotifications() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (session) {
                currentUser = session.user;
                fetchUnreadCount();

                // Poll for new messages every 30 seconds
                setInterval(() => {
                    fetchUnreadCount();
                }, 30000);
            }
        }

        // Call init after page loads
        setTimeout(initNotifications, 1000);
    </script>

</body>
</html>
